name: Build Backend Binary (Windows)

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
      TEMP: ${{ github.workspace }}/build/temp
      TMP: ${{ github.workspace }}/build/temp
      PYINSTALLER_CONFIG_DIR: ${{ github.workspace }}/build/pyinstaller
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'

      - name: Create build directories with proper permissions
        shell: powershell
        run: |
          $buildDir = "${{ github.workspace }}/build"
          $tempDir = "${{ github.workspace }}/build/temp"
          $pyinstallerDir = "${{ github.workspace }}/build/pyinstaller"
          $pyinstallerTemp = "${{ github.workspace }}/build/pyinstaller/temp"
          
          # Clean existing directories
          if (Test-Path $buildDir) {
            Remove-Item $buildDir -Recurse -Force -ErrorAction SilentlyContinue
          }
          
          # Create directories
          New-Item -Path $buildDir -ItemType Directory -Force
          New-Item -Path $tempDir -ItemType Directory -Force
          New-Item -Path $pyinstallerDir -ItemType Directory -Force
          New-Item -Path $pyinstallerTemp -ItemType Directory -Force
          
          # Set full permissions for everyone (GitHub Actions needs this)
          $acl = Get-Acl $buildDir
          $accessRule = New-Object System.Security.AccessControl.FileSystemAccessRule(
            "Everyone", 
            "FullControl", 
            "ContainerInherit,ObjectInherit", 
            "None", 
            "Allow"
          )
          $acl.SetAccessRule($accessRule)
          Set-Acl $buildDir $acl
          
          # Verify permissions
          $currentAcl = Get-Acl $buildDir
          Write-Host "Build directory permissions:"
          $currentAcl.Access | Format-Table
          
          Write-Host "‚úÖ Build directories created with proper permissions"
          Write-Host "üìÅ Build directory: $buildDir"
          Write-Host "üìÅ Temp directory: $tempDir"
          Write-Host "üìÅ PyInstaller directory: $pyinstallerDir"
          Write-Host "üìÅ PyInstaller temp: $pyinstallerTemp"

      - name: Install build dependencies
        shell: bash
        run: |
          # Upgrade pip first
          python -m pip install --upgrade pip
          
          # Install core dependencies
          pip install --upgrade pyinstaller cython setuptools wheel
          
          # Install additional dependencies
          pip install --upgrade ruamel.yaml fastapi uvicorn pydantic aiohttp requests httpx
          
          # Verify installations
          pip list
          python --version
          pyinstaller --version
          cython --version

      - name: Run build.py with detailed logging
        shell: powershell
        run: |
          # Set environment variables explicitly
          $env:PYTHONIOENCODING = "utf-8"
          $env:PYTHONUTF8 = "1"
          $env:TEMP = "${{ github.workspace }}/build/temp"
          $env:TMP = "${{ github.workspace }}/build/temp"
          $env:PYINSTALLER_CONFIG_DIR = "${{ github.workspace }}/build/pyinstaller"
          
          # Verify environment
          Write-Host "Environment variables:"
          Write-Host "PYTHONIOENCODING: $env:PYTHONIOENCODING"
          Write-Host "TEMP: $env:TEMP"
          Write-Host "TMP: $env:TMP"
          Write-Host "Current directory: $(Get-Location)"
          
          # Run the build script
          python build.py
          
          # Check if build was successful
          $exePath = "${{ github.workspace }}/dist/backend.exe"
          if (Test-Path $exePath) {
            $fileSize = (Get-Item $exePath).Length / 1KB
            Write-Host "‚úÖ Build successful! Executable created: $exePath"
            Write-Host "‚úÖ Executable size: $fileSize KB"
            exit 0
          } else {
            Write-Host "‚ùå Build failed! Executable not found at: $exePath"
            Write-Host "üìÅ Contents of dist directory:"
            Get-ChildItem -Path "${{ github.workspace }}/dist" -Recurse | Format-Table
            exit 1
          }

      - name: Verify build output
        shell: powershell
        run: |
          $distDir = "${{ github.workspace }}/dist"
          $exePath = "$distDir/backend.exe"
          
          Write-Host "üìÅ Verifying build output..."
          Write-Host "üìÅ Dist directory: $distDir"
          
          if (Test-Path $distDir) {
            Write-Host "‚úÖ Dist directory exists"
            Write-Host "üìÅ Contents of dist directory:"
            Get-ChildItem -Path $distDir -Recurse | Format-Table
            
            if (Test-Path $exePath) {
              $fileSize = (Get-Item $exePath).Length / 1KB
              Write-Host "‚úÖ Executable found: $exePath"
              Write-Host "‚úÖ Executable size: $fileSize KB"
              exit 0
            } else {
              Write-Host "‚ùå Executable not found at: $exePath"
              exit 1
            }
          } else {
            Write-Host "‚ùå Dist directory does not exist!"
            exit 1
          }

      - name: Upload artifact (30 days)
        uses: actions/upload-artifact@v4
        with:
          name: swarmclonebackend-windows-${{ github.sha }}
          path: dist/
          retention-days: 30
        if: always()

      - name: Create GitHub Release (on tag only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/backend.exe
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}