name: Build Backend Binary

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]
        python-version: ['3.12']
        include:
          - os: windows-latest
            platform_name: windows
            artifact_name: swarmclonebackend-windows.zip
            binary_name: backend.exe

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller==6.9.0 cython setuptools wheel
      shell: bash

    - name: Run build.py to create binary
      id: build_step
      run: |
        echo "Running build.py..."
        python build.py
      shell: bash

    - name: Create distribution directory structure (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        New-Item -Path "dist/swarmclonebackend" -ItemType Directory -Force | Out-Null
        
        if (Test-Path "dist/backend.exe") {
          Copy-Item "dist/backend.exe" "dist/swarmclonebackend/swarmclonebackend.exe"
        }
        
        if (Test-Path "dist/modules") {
          Copy-Item -Path "dist/modules" -Destination "dist/swarmclonebackend/" -Recurse -Force
        }
        
        @("config.yml", "config.yaml", "README.md", "LICENSE") | ForEach-Object {
          if (Test-Path $_) {
            Copy-Item $_ "dist/swarmclonebackend/"
          }
        }
        
        Write-Host "Distribution structure created:"
        Get-ChildItem -Path "dist/swarmclonebackend" -Recurse -File | Sort-Object Name

    - name: Verify distribution directory
      run: |
        if [[ "$(ls -A dist/swarmclonebackend/ 2>/dev/null)" ]]; then
          echo "Distribution directory has files:"
          ls -la dist/swarmclonebackend/
          echo "File count: $(find dist/swarmclonebackend -type f | wc -l)"
        else
          echo "ERROR: Distribution directory is empty!"
          echo "Available in dist/:"
          ls -la dist/ || true
          exit 1
        fi
      shell: bash
      if: runner.os != 'Windows'

    - name: Create zip archive (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        cd dist
        Compress-Archive -Path "swarmclonebackend/*" -DestinationPath "${{ matrix.artifact_name }}" -Force

    - name: Upload artifact (keep for 30 days)
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: dist/${{ matrix.artifact_name }}
        retention-days: 30

    # 如果推送的是标签，自动创建发布版本
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: dist/${{ matrix.artifact_name }}
        generate_release_notes: true
        prerelease: false