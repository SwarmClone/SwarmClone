name: Build Backend Binary

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11']  # 降级到3.11以获得更好的PyInstaller兼容性
        include:
          - os: ubuntu-latest
            platform_name: linux
            artifact_name: swarmclonebackend-linux.zip
            binary_name: swarmclonebackend
          - os: windows-latest
            platform_name: windows
            artifact_name: swarmclonebackend-windows.zip
            binary_name: swarmclonebackend.exe
          - os: macos-latest
            platform_name: macos
            artifact_name: swarmclonebackend-macos.zip
            binary_name: swarmclonebackend
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3-dev python3-venv
        
    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        xcode-select --install || true
        brew install pkg-config || true
        
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        # 使用更稳定的PyInstaller版本
        pip install pyinstaller==6.9.0 cython setuptools wheel
      shell: bash

    - name: Run build.py to create binary
      id: build_step
      run: |
        echo "Running build.py..."
        python build.py
        
        # 检查构建是否成功
        if [[ "${{ matrix.platform_name }}" == "windows" ]]; then
          if [[ -f "dist/backend.exe" ]]; then
            echo "Build successful!"
            echo "binary_path=dist/backend.exe" >> $GITHUB_OUTPUT
          else
            echo "Build failed - no binary found in dist/"
            ls -la dist/
            exit 1
          fi
        else
          if [[ -f "dist/backend" ]]; then
            echo "Build successful!"
            echo "binary_path=dist/backend" >> $GITHUB_OUTPUT
          else
            echo "Build failed - no binary found in dist/"
            ls -la dist/
            exit 1
          fi
        fi
      shell: bash

    - name: Create distribution directory structure (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        # 创建统一的输出目录结构
        mkdir -p dist/swarmclonebackend
        
        # 复制构建的二进制文件
        if [[ -f "dist/backend" ]]; then
          cp dist/backend dist/swarmclonebackend/swarmclonebackend
          chmod +x dist/swarmclonebackend/swarmclonebackend
        fi
        
        # 复制 modules 目录（如果存在）
        if [[ -d "dist/modules" ]]; then
          cp -r dist/modules dist/swarmclonebackend/
        fi
        
        # 复制其他必要的文件
        for file in config.yml config.yaml README.md LICENSE; do
          if [[ -f "$file" ]]; then
            cp "$file" dist/swarmclonebackend/
          fi
        done
        
        echo "Distribution structure created:"
        find dist/swarmclonebackend -type f | sort
      shell: bash

    - name: Create distribution directory structure (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        # 创建统一的输出目录结构
        New-Item -Path "dist/swarmclonebackend" -ItemType Directory -Force | Out-Null
        
        # 复制构建的二进制文件
        if (Test-Path "dist/backend.exe") {
          Copy-Item "dist/backend.exe" "dist/swarmclonebackend/swarmclonebackend.exe"
        }
        
        # 复制 modules 目录（如果存在）
        if (Test-Path "dist/modules") {
          Copy-Item -Path "dist/modules" -Destination "dist/swarmclonebackend/" -Recurse -Force
        }
        
        # 复制其他必要的文件
        @("config.yml", "config.yaml", "README.md", "LICENSE") | ForEach-Object {
          if (Test-Path $_) {
            Copy-Item $_ "dist/swarmclonebackend/"
          }
        }
        
        Write-Host "Distribution structure created:"
        Get-ChildItem -Path "dist/swarmclonebackend" -Recurse -File | Sort-Object Name

    - name: Verify distribution directory
      run: |
        if [[ "$(ls -A dist/swarmclonebackend/ 2>/dev/null)" ]]; then
          echo "Distribution directory has files:"
          ls -la dist/swarmclonebackend/
          echo "File count: $(find dist/swarmclonebackend -type f | wc -l)"
        else
          echo "ERROR: Distribution directory is empty!"
          echo "Available in dist/:"
          ls -la dist/ || true
          exit 1
        fi
      shell: bash
      if: runner.os != 'Windows'

    - name: Verify distribution directory (Windows)
      shell: powershell
      if: runner.os == 'Windows'
      run: |
        if (Get-ChildItem -Path "dist/swarmclonebackend" -Recurse -File) {
          Write-Host "Distribution directory has files:"
          Get-ChildItem -Path "dist/swarmclonebackend" -Recurse | Format-List
          $fileCount = (Get-ChildItem -Path "dist/swarmclonebackend" -Recurse -File).Count
          Write-Host "File count: $fileCount"
        } else {
          Write-Host "ERROR: Distribution directory is empty!" -ForegroundColor Red
          Write-Host "Available in dist/:"
          Get-ChildItem -Path "dist/" -Recurse | Format-List
          exit 1
        }

    - name: Create zip archive (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        cd dist
        zip -r "${{ matrix.artifact_name }}" swarmclonebackend/
      shell: bash

    - name: Create zip archive (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        cd dist
        Compress-Archive -Path "swarmclonebackend/*" -DestinationPath "${{ matrix.artifact_name }}" -Force

    - name: Verify zip archive
      run: |
        if [[ -f "dist/${{ matrix.artifact_name }}" ]]; then
          echo "Zip archive created successfully:"
          ls -lh "dist/${{ matrix.artifact_name }}"
          
          # 显示zip内容
          unzip -l "dist/${{ matrix.artifact_name }}" | head -20
        else
          echo "ERROR: Zip archive not created!"
          ls -la dist/
          exit 1
        fi
      shell: bash
      if: runner.os != 'Windows'

    - name: Verify zip archive (Windows)
      shell: powershell
      if: runner.os == 'Windows'
      run: |
        if (Test-Path "dist/${{ matrix.artifact_name }}") {
          Write-Host "Zip archive created successfully:"
          Get-Item "dist/${{ matrix.artifact_name }}" | Format-List
          
          # 显示zip内容（如果7zip可用）
          if (Get-Command "7z" -ErrorAction SilentlyContinue) {
            Write-Host "Zip contents:"
            7z l "dist/${{ matrix.artifact_name }}" | Select-Object -First 20
          }
        } else {
          Write-Host "ERROR: Zip archive not created!" -ForegroundColor Red
          Get-ChildItem -Path "dist/" | Format-List
          exit 1
        }

    - name: Upload artifact (keep for 30 days)
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: dist/${{ matrix.artifact_name }}
        retention-days: 30

    # 如果推送的是标签，自动创建发布版本
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: dist/${{ matrix.artifact_name }}
        generate_release_notes: true
        prerelease: false

    - name: Clean up build cache (Linux/macOS)
      if: always() && runner.os != 'Windows'
      run: |
        echo "Cleaning up build files..."
        rm -rf dist/swarmclonebackend/ || true
        rm -rf build/ || true
        rm -rf *.spec || true
      shell: bash

    - name: Clean up build cache (Windows)
      if: always() && runner.os == 'Windows'
      shell: powershell
      run: |
        Write-Host "Cleaning up build files..."
        Remove-Item -Path "dist/swarmclonebackend/" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "build/" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "*.spec" -Force -ErrorAction SilentlyContinue
