name: Build Backend Binary

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.12']
        include:
          - os: ubuntu-latest
            platform_name: linux
            artifact_name: swarmclonebackend-linux.zip
            binary_name: swarmclonebackend
          - os: windows-latest
            platform_name: windows
            artifact_name: swarmclonebackend-windows.zip
            binary_name: swarmclonebackend.exe
          - os: macos-latest
            platform_name: macos
            artifact_name: swarmclonebackend-macos.zip
            binary_name: swarmclonebackend
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3-dev
        
    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        xcode-select --install || true
        brew install pkg-config || true
        
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller==6.10.0 cython setuptools
        
    - name: Run build.py to create binary
      id: build_step
      run: |
        echo "Running build.py..."
        python build.py
        
        if [ "${{ matrix.platform_name }}" == "windows" ]; then
          if [ -f "dist/backend.exe" ]; then
            echo "Build successful!"
            echo "binary_path=dist/backend.exe" >> $GITHUB_OUTPUT
          else
            echo "Build failed - no binary found in dist/"
            ls -la dist/
            exit 1
          fi
        else
          if [ -f "dist/backend" ]; then
            echo "Build successful!"
            echo "binary_path=dist/backend" >> $GITHUB_OUTPUT
          else
            echo "Build failed - no binary found in dist/"
            ls -la dist/
            exit 1
          fi
        fi

    - name: Create distribution directory structure
      run: |
        mkdir -p dist/swarmclonebackend
        
        if [ "${{ matrix.platform_name }}" == "windows" ]; then
          if [ -f "dist/backend.exe" ]; then
            cp dist/backend.exe dist/swarmclonebackend/swarmclonebackend.exe
          fi
        else
          if [ -f "dist/backend" ]; then
            cp dist/backend dist/swarmclonebackend/swarmclonebackend
            chmod +x dist/swarmclonebackend/swarmclonebackend
          fi
        fi
        
        if [ -d "dist/modules" ]; then
          cp -r dist/modules dist/swarmclonebackend/
        fi
        
        for file in config.yml config.yaml README.md LICENSE; do
          if [ -f "$file" ]; then
            cp "$file" dist/swarmclonebackend/
          fi
        done
        
        echo "Distribution structure created:"
        find dist/swarmclonebackend -type f || true

    - name: Verify distribution directory
      run: |
        if [ "$(ls -A dist/swarmclonebackend/ 2>/dev/null)" ]; then
          echo "Distribution directory has files:"
          ls -la dist/swarmclonebackend/
          echo "File count: $(find dist/swarmclonebackend -type f | wc -l)"
        else
          echo "ERROR: Distribution directory is empty!"
          echo "Available in dist/:"
          ls -la dist/ || true
          exit 1
        fi

    - name: Create zip archive
      run: |
        cd dist
        if [ "${{ matrix.platform_name }}" == "windows" ]; then
          powershell -Command "Compress-Archive -Path swarmclonebackend/* -DestinationPath '${{ matrix.artifact_name }}'"
        else
          zip -r "${{ matrix.artifact_name }}" swarmclonebackend/
        fi

    - name: Verify zip archive
      run: |
        if [ -f "dist/${{ matrix.artifact_name }}" ]; then
          echo "Zip archive created successfully:"
          ls -lh "dist/${{ matrix.artifact_name }}"
          
          if [ "${{ matrix.platform_name }}" != "windows" ]; then
            echo "Zip contents:"
            unzip -l "dist/${{ matrix.artifact_name }}" || true
          fi
        else
          echo "ERROR: Zip archive not created!"
          exit 1
        fi

    - name: Upload artifact (keep for 30 days)
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: dist/${{ matrix.artifact_name }}
        retention-days: 30

    # 如果推送的是标签，自动创建发布版本
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: dist/${{ matrix.artifact_name }}
        generate_release_notes: true
        prerelease: false

    - name: Clean up build cache
      if: always()
      run: |
        echo "Cleaning up build files..."
        if [ "${{ runner.os }}" == "Windows" ]; then
          powershell -Command "Remove-Item -Path 'dist/swarmclonebackend/' -Recurse -Force -ErrorAction SilentlyContinue"
          powershell -Command "Remove-Item -Path 'build/' -Recurse -Force -ErrorAction SilentlyContinue"
        else
          rm -rf dist/swarmclonebackend/ || true
          rm -rf build/ || true
        fi
